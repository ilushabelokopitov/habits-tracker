@startuml
title Отметка задачи как выполненной

actor "Пользователь" as User
participant "UI" as UI
participant "Контроллер" as Controller
participant "Сервис задач" as TaskService
database "База данных" as DB
participant "Сервис уведомлений" as NotificationService

User -> UI: Нажимает чекбокс\n"Задача выполнена"
activate User
activate UI

UI -> Controller: PATCH /api/tasks/{id}\n{status: "completed"}
deactivate UI
activate Controller

Controller -> TaskService: updateTaskStatus(taskId, "completed")
activate TaskService

TaskService -> DB: UPDATE Tasks\nSET status = 'completed'\nWHERE task_id = taskId
activate DB
DB --> TaskService: rowsAffected
deactivate DB

TaskService -> TaskService: checkIfAllProjectTasksCompleted(taskId)

alt Все задачи проекта выполнены
    TaskService -> NotificationService: notifyProjectCompleted(projectId)
    activate NotificationService
    NotificationService --> TaskService: notificationSent
    deactivate NotificationService
end

TaskService --> Controller: Success()
deactivate TaskService

Controller --> UI: 200 OK
deactivate Controller

activate UI
UI -> UI: Обновить состояние задачи\n(отмечена как выполненная)
UI -> UI: Обновить статистику\n(кол-во выполненных задач)
UI --> User: Показать анимацию/иконку\n"Задача выполнена"
deactivate UI

deactivate User
@enduml
